name: Docker 构建和发布

on:
  push:
    branches:
      - main
  schedule:
    - cron: "13 3 24 * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 检出仓库
        uses: actions/checkout@v2

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: 登录到 Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 获取最新版本
        id: fetch-version
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/dushixiang/next-terminal/releases/latest | jq -r '.tag_name')
          CURRENT_VERSION=$(cat version)
          if [ "$LATEST_VERSION" = "$CURRENT_VERSION" ]; then
            echo "版本匹配，跳过构建。"
            echo "::set-output name=skip_build::true"
          else
            echo "::set-output name=latest_version::$LATEST_VERSION"
          fi

      - name: 构建并推送 Docker 镜像（latest、带版本号和带版本号和时间戳）
        if: steps.fetch-version.outputs.skip_build != 'true'
        run: |
          LATEST_VERSION=${{ steps.fetch-version.outputs.latest_version }}
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          docker buildx build --platform linux/amd64,linux/arm64,linux/arm/v7 -t aaronlee/next-terminal:latest -t aaronlee/next-terminal:${LATEST_VERSION} -t aaronlee/next-terminal:${LATEST_VERSION}-${TIMESTAMP} --push .


      - name: 推送 Docker 镜像标签
        if: steps.fetch-version.outputs.skip_build != 'true'
        run: |
          LATEST_VERSION=${{ steps.fetch-version.outputs.latest_version }}
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          docker push aaronlee/next-terminal:latest
          docker push aaronlee/next-terminal:${LATEST_VERSION}
          docker push aaronlee/next-terminal:${LATEST_VERSION}-${TIMESTAMP}
 
     - name: 更新版本文件并推送到 GitHub
        if: steps.fetch-version.outputs.skip_build != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_VERSION=${{ steps.fetch-version.outputs.latest_version }}
          echo $LATEST_VERSION > version
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git add version
          current_time=$(TZ='Asia/Shanghai' date "+%Y-%m-%d %H:%M:%S")
          git commit -m "版本更新为 $LATEST_VERSION - 北京时间: $current_time"
          git push origin main

      - name: 写入时间到文件
        run: echo $(date +"%Y-%m-%d %H:%M:%S") > time

      - name: 提交和推送时间更改
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add time
          current_time=$(TZ='Asia/Shanghai' date "+%Y-%m-%d %H:%M:%S")
          git commit -m "运行时间 - 北京时间: $current_time"
          git push origin main
